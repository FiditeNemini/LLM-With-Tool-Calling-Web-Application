<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LM Studio Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 50px;
            height: calc(100vh - 250px);
            border-bottom: solid 1px lightgray;
        }
        .message pre {
            background-color: #f6f8fa;
            border-radius: 6px;
            padding: 16px;
            overflow-x: auto;
        }
        .message code {
            font-family: monospace;
            font-size: 85%;
            background-color: rgba(175, 184, 193, 0.2);
            border-radius: 6px;
            padding: 0.2em 0.4em;
        }
        .message pre code {
            background-color: transparent;
            padding: 0;
        }
        .message p { 
            white-space: pre-wrap; 
            max-width: 100%;
            word-wrap: break-word;
        }
        
        .mx-3 {
            max-width: calc(100% - 4rem) !important;
            word-break: break-word;
        }
        
        .assistant-content, 
        .assistant-content > div {
            max-width: 100%;
            overflow-wrap: break-word;
        }

        .input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to bottom, transparent, rgb(243 244 246 / 0.8) 20%);
            padding-bottom: 1rem;
            backdrop-filter: blur(10px);
            transition: padding-left 0.3s ease;
        }

        .input-container.shifted {
            padding-left: 300px;
        }

        .input-group {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 1.25rem;
            padding: 0.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }

        .input-group:focus-within {
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
            border-color: #3b82f6;
        }

        #userInput {
            width: 100%;
            resize: none;
            border: none;
            padding: 0.75rem;
            font-size: 0.95rem;
            line-height: 1.5;
            background: transparent;
        }

        .button-group button {
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 1.25rem;
            cursor: pointer;
            outline: none;
            transform: translateY(0);
            transition: all 0.15s ease;
            padding: 0.5rem 0.75rem;
            box-shadow: 
                0 5px 0 #d1d5db,
                0 3px 3px rgba(0, 0, 0, 0.1);
        }

        .button-group button:hover {
            transform: translateY(-1px);
            box-shadow: 
                0 7px 0 #d1d5db,
                0 4px 4px rgba(0, 0, 0, 0.1);
        }

        .button-group button:active {
            transform: translateY(1px);
            box-shadow: 
                0 1px 0 #d1d5db,
                0 2px 2px rgba(0, 0, 0, 0.1);
        }

        .button-group {
            display: flex;
            justify-content: center;
        }

        .tool-loading {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            margin: 0.5rem 0;
        }

        .markdown-content a {color: #3b82f6;}

        .markdown-content a:hover {text-decoration: underline;}

        .conversation-list {
            position: fixed;
            left: 0;
            top: 10%;
            bottom: 10%;
            width: 300px;
            background: white;
            border-right: 1px solid #e5e7eb;
            overflow-y: auto;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 50;
            border-radius: 1rem;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            flex: 1;
            padding-bottom: 60px;
        }

        .conversation-content {
            flex: 1;
            min-width: 0;
        }

        .conversation-item .text-sm {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #newButton {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 1rem;
            background: #ffffff71;
            border-top: 1px solid #e5e7eb;
            z-index: 51;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        #newButton:hover {
            background-color: #f6ff0071;
        }

        .conversation-list.visible {
            transform: translateX(5px);
        }
        
        .conversation-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }

        .delete-button {
            padding: 0.25rem 0.5rem;
            background-color: #fee2e2;
            color: #dc2626;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
            opacity: 0;
            position: absolute;
            right: 1rem;
            top: 50%;
        }

        .conversation-item:hover .delete-button {
            opacity: 1;
        }

        .delete-button:hover {
            background-color: #fecaca;
        }

        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 101;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .modal-button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            border: 1px solid #e5e7eb;
        }
        
        .confirm-delete {
            background-color: #dc2626;
            color: white;
            border: none;
        }
        
        .cancel-delete {
            background-color: white;
        }
        
        .conversation-item:hover {
            background-color: #f3f4f6;
        }
        
        .conversation-item.active {
            background-color: #e5e7eb;
        }

        .content-wrapper {
            transition: margin-left 0.3s ease;
        }

        .content-wrapper.shifted {
            margin-left: 300px;
        }

        .toggle-conversations {
            position: fixed;
            left: 1rem;
            top: 1rem;
            z-index: 60;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.5rem;
            box-shadow: 0 4px 4px rgba(0, 0, 0, 0.1);
        }

        .button-action {
            border: 1px solid #d1d5db;
            border-radius: 1.25rem;
            cursor: pointer;
            padding: 0.5rem 0.75rem;
            transition: all 0.15s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            left: 50rem;
            box-shadow: 
                0 5px 0 #d1d5db,
                0 3px 3px rgba(0, 0, 0, 0.1);
        }
        
        .action-group {
            padding: 8px;
            justify-content: center;
        }

        .action-group button:hover {
            transform: translateY(-1px);
            box-shadow: 
                0 7px 0 #d1d5db,
                0 4px 4px rgba(0, 0, 0, 0.1);
        }

        .action-group button:active {
            transform: translateY(1px);
            box-shadow: 
                0 1px 0 #d1d5db,
                0 2px 2px rgba(0, 0, 0, 0.1);
        }

        .markdown-content img {
            margin: 1rem 0; /* Add some vertical spacing */
            border-radius: 0.5rem; /* Optional: rounded corners */
        }

        .spinner {
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #e5e7eb;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
    </style>
</head>
<div class="modal-backdrop" id="deleteModal">
    <div class="modal">
        <h3 class="text-lg font-medium mb-2">Delete Conversation</h3>
        <p>Are you sure you want to delete this conversation? This action cannot be undone.</p>
        <div class="modal-buttons">
            <button class="modal-button cancel-delete" id="cancelDelete">Cancel</button>
            <button class="modal-button confirm-delete" id="confirmDelete">Delete</button>
        </div>
    </div>
</div>

<body class="bg-gray-100">
    <button class="toggle-conversations" data-expanded="false">
        💬➡️
    </button>

    <div class="conversation-list">
        <div class="p-4 border-b">
            <h2 class="text-xl font-bold">Chat History</h2>
        </div>
        <div id="conversationsList"></div>
        <button id="newButton" class="text-l transition-opacity p-2 clear-btn" title="New chat">➕ New Chat</button>
    </div>

    <div class="content-wrapper">
        <div class="container mx-auto p-4 max-w-4xl">
            <div class="bg-white rounded-lg shadow-lg mb-24">
                <div class="p-4 border-b">
                    <h1 class="text-2xl font-bold text-gray-800">LM Studio Chat 👾</h1>
                </div>
                <div class="messages-container p-4" id="messages"></div>
                <div class="action-group flex justify-end space-x-2 p-4">
                    <button id="deleteLastMessageButton" class="button-action", title="Delete Last Message">
                        <img src="/static/delete.png" alt="Delete Last Message" width="20" height="20">
                    </button>
                    <button id="regenerateResponseButton" class="button-action", title="Regenerate Last Response">
                        <img src="/static/repeat.png" alt="Regenerate Response" width="20" height="20">
                    </button>
                </div>
            </div>
        </div>
    
        <div class="input-container">
            <div class="container mx-auto px-4 max-w-4xl">
                <div class="input-group">
                    <div class="flex items-start space-x-3">
                        <textarea id="userInput"
                            class="flex-grow focus:outline-none"
                            rows="2"
                            placeholder="Message here"></textarea>
                        <div class="button-group flex items-center space-x-2">
                            <button id="sendButton" class="visible transition-opacity p-2 send-btn" title="Send message">
                                <img src="static\send-message.png" alt="send" class="w-8 h-8 rounded-full">
                            </button>
                            <button id="interruptButton" class="hidden transition-opacity p-2 stop-btn" title="Stop generation">
                                <img src="static\stop.png" alt="send" class="w-8 h-8 rounded-full", height="5", width="5">
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    

    <script>
        marked.setOptions({
            highlight: function(code, lang) {
                return hljs.highlightAuto(code).value;
            }
        });

        const els = {
            messages: document.getElementById('messages'),
            userInput: document.getElementById('userInput'),
            sendButton: document.getElementById('sendButton'),
            interruptButton: document.getElementById('interruptButton'),
            newButton: document.getElementById('newButton')
        };
        
        let currentResponse = '';
        let currentMessageElement = null;
        let currentConversationId = null;
        const DEFAULT_ROWS = 1;
        let conversationToDelete = null;
        const deleteModal = document.getElementById('deleteModal');
        const confirmDelete = document.getElementById('confirmDelete');
        const cancelDelete = document.getElementById('cancelDelete');
        let isAtBottom = true;
        document.getElementById('deleteLastMessageButton').onclick = deleteLastMessage;
        document.getElementById('regenerateResponseButton').onclick = regenerateResponse;

        function isUserAtBottom() {
            const container = els.messages;
            return (container.scrollHeight - container.scrollTop - container.clientHeight) < 20;
        }

        function scrollToBottomIfNeeded() {
            if (isAtBottom) {
                els.messages.scrollTop = els.messages.scrollHeight;
            }
        }

        async function deleteConversation(conversationId, event) {
            event.stopPropagation();
            conversationToDelete = conversationId;
            deleteModal.style.display = 'block';
        }

        async function loadConversations() {
            try {
                const response = await fetch('/conversations');
                const conversations = await response.json();
                
                const container = document.getElementById('conversationsList');
                container.innerHTML = '';
                
                conversations.forEach(conv => {
                    const div = document.createElement('div');
                    div.className = `conversation-item ${conv.id === currentConversationId ? 'active' : ''}`;
                    div.dataset.id = conv.id;
                    div.innerHTML = `
                        <div class="conversation-content" onclick="loadConversation('${conv.id}')">
                            <div class="text-sm font-bold mb-1">${conv.name}</div>
                            <div class="text-xs text-gray-500">${new Date(conv.last_updated).toLocaleString()}</div>
                        </div>
                        <button class="delete-button" onclick="deleteConversation('${conv.id}', event)">
                            Delete
                        </button>
                    `;
                    
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('Error loading conversations:', error);
            }
        }
        async function loadConversation(conversationId) {
            try {
                const response = await fetch(`/conversation/${conversationId}`);
                const data = await response.json();
                currentConversationId = conversationId;

                els.messages.innerHTML = '';
                document.querySelectorAll('.conversation-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.id === conversationId) {
                        item.classList.add('active');
                    }
                });
                
                const messagesResponse = await fetch('/messages');
                const formattedMessages = await messagesResponse.json();
                
                const groupedMessages = formattedMessages.reduce((acc, msg) => {
                    if (msg.isUser) {
                        acc.push(msg);
                    } else {
                        if (msg.content || (msg.tool_results && msg.tool_results.length > 0)) {
                            if (acc.length > 0 && !acc[acc.length - 1].isUser) {
                                const lastMsg = acc[acc.length - 1];
                                if (msg.content) {
                                    lastMsg.content = lastMsg.content ? 
                                        `${lastMsg.content}\n\n${msg.content}` : msg.content;
                                }
                                if (msg.tool_results) {
                                    lastMsg.tool_results = (lastMsg.tool_results || [])
                                        .concat(msg.tool_results);
                                }
                            } else {
                                acc.push({
                                    isUser: false,
                                    content: msg.content || '',
                                    tool_results: msg.tool_results || []
                                });
                            }
                        }
                    }
                    return acc;
                }, []);

                groupedMessages.forEach(msg => {
                    const messageEl = createMessageElement(msg.isUser, msg.content);
                    
                    if (!msg.isUser) {
                        const container = messageEl.querySelector('.assistant-content');
                        
                        if (container && msg.content) {
                            const markdownDiv = document.createElement('div');
                            markdownDiv.className = 'markdown-content';
                            markdownDiv.innerHTML = marked.parse(msg.content);
                            container.insertBefore(markdownDiv, container.firstChild);
                        }
                        
                        if (msg.tool_results && msg.tool_results.length > 0) {
                            msg.tool_results.forEach(result => {
                                currentMessageElement = messageEl; 
                                addResult(result.name, result.content, result.args);
                            });
                        }
                        messageEl.querySelectorAll('pre code').forEach(hljs.highlightBlock);
                    }
                });
                
                scrollToBottomIfNeeded();
            } catch (error) {
                console.error('Error loading conversation:', error);
            }
        }

        window.currentMessageElement = null;

        async function deleteLastMessage() {
            try {
                const response = await fetch('/delete-last', { method: 'POST' });
                const data = await response.json();
                
                if (data.status === 'success') {
                    const messagesContainer = els.messages;
                    const messageElements = Array.from(messagesContainer.children);
                    
                    if (messageElements.length >= 2) {
                        let lastUserIndex = -1;
                        for (let i = messageElements.length - 1; i >= 0; i--) {
                            const messageEl = messageElements[i];
                            if (messageEl.querySelector('.bg-blue-500')) {
                                lastUserIndex = i;
                                break;
                            }
                        }
                        
                        if (lastUserIndex !== -1) {
                            for (let i = messageElements.length - 1; i >= lastUserIndex; i--) {
                                messageElements[i].remove();
                            }
                        }
                    }
                    await loadConversations();
                }
            } catch (error) {
                console.error('Error deleting messages:', error);
            }
        }

        async function regenerateResponse() {
            try {
                const response = await fetch('/regenerate', { method: 'POST' });
                const data = await response.json();
                
                if (data.status === 'success') {
                    const messages = els.messages.children;
                    if (messages.length >= 1) {
                        messages[messages.length - 1].remove();
                        await handleMessage(data.message);
                    }
                }
            } catch (error) {
                console.error('Error regenerating response:', error);
            }
        }

        function createMessageElement(isUser, content) {
            const avatar = isUser ? '/static/man.png' : '/static/bot.png';
            const bgColor = isUser ? 'bg-blue-500' : 'bg-gray-100';
            const textColor = isUser ? 'text-white' : 'text-black';
            const alignment = isUser ? 'justify-end' : '';
            
            const formattedContent = isUser ? content
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\n/g, '<br>') : content;
            
            const div = document.createElement('div');
            div.innerHTML = `
                <div class="flex items-start mb-4 ${alignment}">
                    ${!isUser ? `
                        <img src="${avatar}" alt="Avatar" class="w-8 h-8 rounded-full">
                    ` : ''}
                    <div class="mx-3 ${bgColor} rounded-lg py-2 px-4 max-w-3xl ${textColor}">
                        ${isUser ? `<div style="white-space: pre-wrap;">${formattedContent}</div>` : '<div class="assistant-content"></div>'}
                    </div>
                    ${isUser ? `<img src="${avatar}" alt="Avatar" class="w-8 h-8 rounded-full">` : ''}
                </div>
            `;
            els.messages.appendChild(div);
            scrollToBottomIfNeeded();
            return div;
        }

        function createLoadingIndicator(tool_info) {
            const div = document.createElement('div');
            div.className = 'tool-loading';
            if (tool_info.name === 'python') {
                div.innerHTML = `
                    <div class="spinner"></div>
                    <span>Executing Python code...</span>
                `;
                return div;
            }else if (tool_info.name === 'web') {
                div.innerHTML = `
                    <div class="spinner"></div>
                    <span>Searching the web for ${tool_info.args.query}</span>
                `;
            }else if (tool_info.name === 'wiki') {
                div.innerHTML = `
                    <div class="spinner"></div>
                    <span>Searching Wikipedia for ${tool_info.args.query}</span>
                `;
            }else if (tool_info.name === 'web_url') {
                div.innerHTML = `
                    <div class="spinner"></div>
                    <span>Scraping content from the website</span>
                `;
            }
            else if (tool_info.name === 'video') {
                div.innerHTML = `
                    <div class="spinner"></div>
                    <span>Searhcing youtube for  ${tool_info.args.query}</span>
                `;
            }else if (tool_info.name === 'image') {
                div.innerHTML = `
                    <div class="spinner"></div>
                    <span>Searching images about ${tool_info.args.query}</span>
                `;
            }else if (tool_info.name === 'yt_url') {
                div.innerHTML = `
                    <div class="spinner"></div>
                    <span>Getting Youtube video information<span>
                `;
            }
            else {
                div.innerHTML = `
                    <div class="spinner"></div>
                    <span>Using Tool ${tool_info.name}</span>
            `;
            }
            return div;
        }

        function addResult(name, data, args) {
            const generators = {
                python: () => ({
                    title: 'Python Execution', icon: '🐍',
                    content: `<div class="space-y-4">
                        <div><div class="text-sm text-gray-500 mb-1">Code</div><pre><code class="language-python">${args.code}</code></pre></div>
                        ${data.success ? 
                            `${data.output ? `<div><div class="text-sm text-gray-500 mb-1">Output</div><pre><code>${data.output}</code></pre></div>` : ''}
                            ${data.result !== null ? `<div><div class="text-sm text-gray-500 mb-1">Result</div><pre><code>${JSON.stringify(data.result)}</code></pre></div>` : ''}`
                            : `<div><div class="text-sm text-red-500 mb-1">Error</div><pre><code>${data.error}</code></pre></div>`}
                    </div>`,
                    className: data.success ? 'bg-white' : 'bg-red-50'
                }),
                image: () => ({
                    title: args.query, icon: '🖼️',
                    content: `<div class="grid grid-cols-1 sm:grid-cols-5 gap-4">
                        ${(Array.isArray(data) ? data : [data]).map(item => `
                            <div class="rounded-lg overflow-hidden border border-gray-200">
                                <a href="${item.image}" target="_blank" class="block relative group">
                                    <img src="${item.thumbnail || item.image}" alt="Search result" 
                                        class="w-full h-24 object-cover transform transition-transform duration-200 group-hover:scale-105">
                                    <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-opacity duration-200"></div>
                                    <div class="absolute bottom-0 left-0 right-0 p-2 bg-gradient-to-t from-black/50 to-transparent">
                                        <div class="text-xs text-white">Click to view full size</div>
                                    </div>
                                </a>
                            </div>
                        `).join('')}
                    </div>`,
                    className: 'bg-white'
                }),
                video: () => ({
                    title: args.query, icon: '🎥',
                    content: `<div class="space-y-4">${(Array.isArray(data) ? data : [data]).map(item => {
                        const vidId = (item.url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\s]+)/) || [])[1];
                        return vidId ? 
                            `<div class="mb-4"><div class="text-sm font-medium mb-2">${item.title}</div>
                            <div class="rounded-lg bg-gray-50 p-4"><div class="flex items-center space-x-3">
                            <img src="https://img.youtube.com/vi/${vidId}/default.jpg" alt="Thumbnail" class="w-24 h-auto rounded">
                            <div><a href="https://www.youtube.com/watch?v=${vidId}" target="_blank" class="text-blue-600 hover:underline">Watch on YouTube</a>
                            <div class="text-sm text-gray-600">ID: ${vidId}</div></div></div></div></div>` :
                            `<div class="mb-4"><div class="text-sm font-medium mb-2">${item.title}</div>
                            <a href="${item.content}" target="_blank" class="text-blue-600 hover:underline">${item.content}</a></div>`;
                    }).join('')}</div>`,
                    className: 'bg-white'
                }),
                web: () => ({
                    title: args.query, icon: '🌐',
                    content: Array.isArray(data) ? 
                        `<div class="space-y-4">${data.map(r => 
                            `<div><a href="${r.url}" target="_blank" class="text-sm text-blue-600 hover:underline mb-2 block">${r.url}</a>
                            <div class="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg">${r.citation}</div></div>`
                        ).join('')}</div>` : 
                        `<div class="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg">${data}</div>`,
                    className: 'bg-white'
                }),
                wiki: () => ({
                    title: data.title, icon: '📚',
                    content: `<div class="text-sm text-gray-600">${data.content}</div>`,
                    className: 'bg-white'
                }),
                yt_url: () => ({
                    title: data.title, icon: '▶️',
                    content: `<div class="text-sm text-gray-600">${data.content}</div>
                                <div class="text-sm text-gray-600">${data.transcription}</div>`,
                    className: 'bg-white'
                }),
                web_url: () => ({
                    title: data.title || "Unable to open URL", icon: '🔗',
                    content: `<div><a href="${args.url}" target="_blank" class="text-sm text-blue-600 hover:underline mb-2 block">${args.url}</a>
                            <div class="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg">${data.content}</div></div>`,
                    className: 'bg-white'
                })
            };

            const { title, icon, content, className } = (generators[name] || (() => ({
                title: name, icon: '🔧',
                content: `<div class="text-sm text-gray-600">${JSON.stringify(data)}</div>`,
                className: 'bg-white'
            })))();

            const resultDiv = document.createElement('div');
            resultDiv.className = 'mt-3';
            resultDiv.innerHTML = `
                <div class="border border-gray-200 rounded-lg overflow-hidden ${className}">
                    <div class="flex items-center justify-between p-3 cursor-pointer hover:bg-gray-50" role="button" tabindex="0">
                        <div class="flex items-center space-x-2"><span class="text-lg">${icon}</span><h3 class="font-medium">${title}</h3></div>
                        <button class="toggle-content text-gray-400"><svg class="w-5 h-5 transition-transform" viewBox="0 0 24 24">
                            <path stroke="currentColor" stroke-width="2" d="M19 9l-7 7-7-7" fill="none"/>
                        </svg></button>
                    </div>
                    <div class="content hidden"><div class="px-4 pb-4 pt-1">${content}</div></div>
                </div>`;

            const container = currentMessageElement.querySelector('.assistant-content');
            if (!container) return;
            container.appendChild(resultDiv);

            const toggleSection = resultDiv.querySelector('[role="button"]');
            const toggleBtn = resultDiv.querySelector('.toggle-content svg');
            const contentDiv = resultDiv.querySelector('.content');
            
            if (toggleSection && contentDiv) {
                const toggle = () => {
                    const isHidden = contentDiv.classList.contains('hidden');
                    contentDiv.classList.toggle('hidden');
                    toggleBtn.style.transform = isHidden ? 'rotate(-180deg)' : '';
                    if (!isHidden) contentDiv.querySelectorAll('pre code').forEach(hljs.highlightBlock);
                    resultDiv.querySelector('.border').classList.toggle('rounded-lg', !isHidden);
                };
                toggleSection.onclick = toggle;
                toggleSection.onkeydown = e => ['Enter', ' '].includes(e.key) && (e.preventDefault(), toggle());
            }
        }

        function processStreamMessage(line) {
            if (!line.startsWith('data: ')) return;
            
            const data = line.slice(5).trim();
            if (!data || data === '[DONE]') return;
            
            try {
                const parsed = JSON.parse(data);
                const container = currentMessageElement.querySelector('.assistant-content');
                
                switch (parsed.type) {
                    case 'content':
                        currentResponse += parsed.content;
                        let markdownDiv = container.querySelector('.markdown-content');
                        if (!markdownDiv) {
                            markdownDiv = document.createElement('div');
                            markdownDiv.className = 'markdown-content';
                            container.insertBefore(markdownDiv, container.firstChild);
                        }
                        markdownDiv.innerHTML = marked.parse(currentResponse);
                        markdownDiv.querySelectorAll('pre code').forEach(hljs.highlightBlock);
                        break;
                        
                    case 'tool':
                        const existingLoader = container.querySelector('.tool-loading');
                        if (existingLoader) {
                            existingLoader.remove();
                        }
                        addResult(parsed.name, parsed.content, parsed.args);
                        break;
                        
                    case 'tool-start':
                        if (!container.querySelector('.tool-loading')) {
                            container.appendChild(createLoadingIndicator(parsed));
                        }
                        break;
                }
                
            } catch (error) {
                console.error('Parse error:', error, 'Data:', data);
            }
        }
        async function handleMessage(existingMessage = null) {
            const message = existingMessage || els.userInput.value.trim();
            if (!message) return;

            if (!existingMessage) {
                els.userInput.value = '';
                els.userInput.rows = DEFAULT_ROWS;
                createMessageElement(true, message);
            }

            els.sendButton.classList.add('hidden');
            els.interruptButton.classList.remove('hidden');

            currentMessageElement = createMessageElement(false);
            currentResponse = '';

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    decoder.decode(value)
                        .split('\n')
                        .filter(Boolean)
                        .forEach(processStreamMessage);
                        
                    scrollToBottomIfNeeded();
                }
                await loadConversations();
            } catch (error) {
                console.error('Error:', error);
                currentMessageElement.querySelector('.assistant-content').innerHTML += 
                    `<p class="text-red-500">Error: ${error.message}</p>`;
            } finally {
                els.sendButton.classList.remove('hidden');
                els.interruptButton.classList.add('hidden');
                els.userInput.focus();
                document.querySelectorAll('pre code').forEach(hljs.highlightBlock);
            }
        }

        function adjustTextareaHeight() {
            const textarea = els.userInput;
            textarea.rows = DEFAULT_ROWS;
            const maxRows = 10;
            const lines = textarea.value.split('\n').length;
            const calculatedRows = Math.min(Math.max(lines, DEFAULT_ROWS), maxRows);
            
            textarea.rows = calculatedRows;
            textarea.style.overflowY = lines > maxRows ? 'auto' : 'hidden';
        }
        els.sendButton.onclick = (event) => {
            event.preventDefault();
            handleMessage();
        };
        els.userInput.onkeypress = e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleMessage();
            }
        };
        els.userInput.oninput = adjustTextareaHeight;
        
        els.interruptButton.onclick = async () => {
            try {
                await fetch('/interrupt', { method: 'POST' });
            } catch (error) {
                console.error('Error interrupting:', error);
            } finally {
                els.interruptButton.classList.add('hidden');
                els.sendButton.classList.remove('hidden');
                els.sendButton.disabled = false;
                els.userInput.disabled = false;
                document.querySelectorAll('.tool-loading').forEach(el => el.remove());
        
                if (currentMessageElement) {
                    const assistantContent = currentMessageElement.querySelector('.assistant-content');
                    if (assistantContent) {
                        let markdownDiv = assistantContent.querySelector('.markdown-content');
                        if (markdownDiv) {
                            markdownDiv.innerHTML = marked.parse(currentResponse);
                        } else {
                            markdownDiv = document.createElement('div');
                            markdownDiv.className = 'markdown-content';
                            markdownDiv.innerHTML = marked.parse(currentResponse);
                            assistantContent.insertBefore(markdownDiv, assistantContent.firstChild);
                        }
                    }
                }
                
                currentResponse = '';
                currentMessageElement = null;
                els.userInput.focus();
            }
        };
        els.newButton.onclick = async () => {
            try {
                const response = await fetch('/new', { method: 'POST' });
                const data = await response.json();
                
                currentConversationId = data.conversation_id;
                els.messages.innerHTML = '';
                await loadConversations();
            } catch (error) {
                console.error('Error creating new conversation:', error);
            }
        };

        cancelDelete.onclick = () => {
            deleteModal.style.display = 'none';
            conversationToDelete = null;
        };
        deleteModal.onclick = (event) => {
            if (event.target === deleteModal) {
                deleteModal.style.display = 'none';
                conversationToDelete = null;
            }
        };

        confirmDelete.onclick = async () => {
            if (!conversationToDelete) return;

            try {
                const response = await fetch(`/conversation/${conversationToDelete}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.status === 'success') {
                    if (conversationToDelete === currentConversationId) {
                        els.messages.innerHTML = '';
                        currentConversationId = null;
                    }
                    await loadConversations();
                }
            } catch (error) {
                console.error('Error deleting conversation:', error);
            } finally {
                deleteModal.style.display = 'none';
                conversationToDelete = null;
            }
        };

        els.messages.onscroll = () => {
            isAtBottom = isUserAtBottom();
        };
        document.querySelector('.toggle-conversations').onclick = () => {
            const toggleBtn = document.querySelector('.toggle-conversations');
            const isExpanded = toggleBtn.dataset.expanded === 'true';
            
            document.querySelector('.conversation-list').classList.toggle('visible');
            document.querySelector('.content-wrapper').classList.toggle('shifted');
            document.querySelector('.input-container').classList.toggle('shifted');
            
            toggleBtn.dataset.expanded = !isExpanded;
            toggleBtn.textContent = isExpanded ? '💬➡️' : '💬⬅️';
        };


        document.addEventListener('DOMContentLoaded', async () => {
            await loadConversations();
            try {
                const response = await fetch('/messages');
                const messages = await response.json();
                
                // Using the same grouping logic as in loadConversation
                const groupedMessages = messages.reduce((acc, msg) => {
                    if (msg.isUser) {
                        // Always add user messages as new entries
                        acc.push(msg);
                    } else {
                        // For assistant messages, check if it contains new content
                        if (msg.content || (msg.tool_results && msg.tool_results.length > 0)) {
                            // If the last message was from the assistant and this message has new content
                            if (acc.length > 0 && !acc[acc.length - 1].isUser) {
                                const lastMsg = acc[acc.length - 1];
                                // Append content if the current message has content
                                if (msg.content) {
                                    lastMsg.content = lastMsg.content ? 
                                        `${lastMsg.content}\n\n${msg.content}` : msg.content;
                                }
                                // Append tool results if present
                                if (msg.tool_results) {
                                    lastMsg.tool_results = (lastMsg.tool_results || [])
                                        .concat(msg.tool_results);
                                }
                            } else {
                                // Create a new assistant message entry
                                acc.push({
                                    isUser: false,
                                    content: msg.content || '',
                                    tool_results: msg.tool_results || []
                                });
                            }
                        }
                    }
                    return acc;
                }, []);
                
                groupedMessages.forEach(msg => {
                    const messageEl = createMessageElement(msg.isUser, msg.content);
                    
                    if (!msg.isUser) {
                        const container = messageEl.querySelector('.assistant-content');
                        
                        if (container && msg.content) {
                            const markdownDiv = document.createElement('div');
                            markdownDiv.className = 'markdown-content';
                            markdownDiv.innerHTML = marked.parse(msg.content);
                            container.insertBefore(markdownDiv, container.firstChild);
                        }
                        
                        if (msg.tool_results && msg.tool_results.length > 0) {
                            msg.tool_results.forEach(result => {
                                currentMessageElement = messageEl;
                                addResult(result.name, result.content, result.args);
                            });
                        }
                        
                        messageEl.querySelectorAll('pre code').forEach(hljs.highlightBlock);
                    }
                });
                
                scrollToBottomIfNeeded();
            } catch (error) {
                console.error('Error loading messages:', error);
            }
            
            els.userInput.focus();
            adjustTextareaHeight();
        });
    </script>
</body>
</html